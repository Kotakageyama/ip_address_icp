# バックエンドアーキテクチャ

## 概要

本プロジェクトのバックエンドは、Internet Computer Protocol (ICP) 上で動作するMotoko言語で書かれたCanisterとして実装されています。IPアドレス情報と位置データの永続化、統計情報の管理を行います。

## アーキテクチャ図

```
┌─────────────────────────────────────────────────────┐
│                 Internet Computer                   │
│  ┌───────────────────────────────────────────────┐  │
│  │           Backend Canister                    │  │
│  │  ┌─────────────────────────────────────────┐  │  │
│  │  │              main.mo                    │  │  │
│  │  │  ┌─────────────────────────────────┐    │  │  │
│  │  │  │      Data Types                 │    │  │  │
│  │  │  │  • IpInfo Record               │    │  │  │
│  │  │  │  • Visit History Array         │    │  │  │
│  │  │  └─────────────────────────────────┘    │  │  │
│  │  │  ┌─────────────────────────────────┐    │  │  │
│  │  │  │      Public Functions           │    │  │  │
│  │  │  │  • recordVisit()               │    │  │  │
│  │  │  │  • getLatestVisits()           │    │  │  │
│  │  │  │  • getAllVisits()              │    │  │  │
│  │  │  │  • getStats()                  │    │  │  │
│  │  │  │  • whoami()                    │    │  │  │
│  │  │  └─────────────────────────────────┘    │  │  │
│  │  └─────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
```

## 技術スタック

- **言語**: Motoko
- **実行環境**: Internet Computer Canister
- **データストレージ**: Canister内メモリ（永続化）
- **通信プロトコル**: Candid IDL

## データモデル

### IpInfo 型定義

```motoko
public type IpInfo = {
    ip: Text;           // IPアドレス
    country: Text;      // 国名
    region: Text;       // 地域/州名
    city: Text;         // 都市名
    latitude: Text;     // 緯度
    longitude: Text;    // 経度
    timezone: Text;     // タイムゾーン
    isp: Text;          // インターネットプロバイダー
    timestamp: Int;     // 訪問時刻（Motoko時間）
};
```

### データストレージ

```motoko
private var visitHistory: [IpInfo] = [];
```

訪問履歴は配列として管理され、Canisterのアップグレード時にも永続化されます。

## API仕様

### `recordVisit(ipInfo: IpInfo): async Bool`

**目的**: 新しい訪問者の情報を記録

**パラメータ**:
- `ipInfo`: 訪問者のIP情報

**戻り値**: 
- `Bool`: 記録成功時 `true`

**動作**:
1. 現在時刻をタイムスタンプとして設定
2. 訪問履歴配列に新しいエントリを追加

### `getLatestVisits(count: Nat): async [IpInfo]`

**目的**: 最新の訪問記録を指定件数取得

**パラメータ**:
- `count`: 取得したい件数

**戻り値**: 
- `[IpInfo]`: 最新の訪問記録の配列

**動作**:
1. 全体の訪問件数を確認
2. 指定件数またはすべての記録を返却

### `getAllVisits(): async [IpInfo]`

**目的**: 全ての訪問記録を取得

**戻り値**: 
- `[IpInfo]`: 全訪問記録の配列

### `getStats(): async {totalVisits: Nat; uniqueCountries: Nat}`

**目的**: 統計情報を取得

**戻り値**: 
- `totalVisits`: 総訪問数
- `uniqueCountries`: ユニークな国の数

**動作**:
1. 総訪問数をカウント
2. 重複しない国名をカウント

### `whoami(): async Text`

**目的**: Canisterの識別情報を取得

**戻り値**: 
- `Text`: Canisterの説明文

## セキュリティ考慮事項

### データプライバシー
- IPアドレス情報は匿名化されて保存
- 個人を特定できる情報は収集しない

### アクセス制御
- 読み取り操作は `query` 関数として実装（高速）
- 書き込み操作は通常の `update` 関数として実装

### データ整合性
- Motokoの型システムによる型安全性
- 不正なデータ形式の拒否

## パフォーマンス特性

### 計算量
- `recordVisit`: O(1) - 単純な配列追加
- `getLatestVisits`: O(n) - 配列の一部抽出
- `getStats`: O(n) - 全記録のスキャン

### メモリ使用量
- 1訪問記録あたり約200-300バイト
- 10,000件の訪問で約2-3MB

### スケーラビリティ
- Canisterのメモリ制限: 4GB
- 推定最大記録数: 約1,000万件

## デプロイメント

### ローカル開発
```bash
dfx start --background
dfx deploy --network local
```

### IC本番環境
```bash
dfx deploy --network ic
```

## モニタリング

### ログ出力
- デバッグ情報は `Debug.print()` で出力
- エラーハンドリングは Motoko の型システムで管理

### 統計情報
- `getStats()` 関数で訪問統計を取得可能
- フロントエンドから定期的にポーリング

## 今後の拡張予定

1. **データベース統合**: より大規模なデータに対応
2. **レート制限**: スパム対策の実装
3. **データ分析**: より詳細な統計機能
4. **キャッシング**: クエリパフォーマンスの向上
5. **バックアップ**: データのレプリケーション機能 